jobs:
  - job: breakpad_macos
    displayName: Breakpad (MacOS, x86_64)
    pool:
      vmImage: "macos-10.13"
    steps:
      - template: prescript-common.yml
      - bash: |
          set -eux
          cd breakpad/
          make build-macos-all
      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: "breakpad/macos/dist/out/breakpad-Darwin.zip"
      - template: zeus-upload.yml
        parameters:
          path: ./breakpad/dist
          pattern: "*.zip"
          uploadName: "breakpad-Darwin-x86_64.zip"
      - template: zeus-report.yml

  - job: breakpad_linux
    displayName: Breakpad (Linux, x86_64)
    pool:
      vmImage: "ubuntu-16.04"
    steps:
      - template: prescript-common.yml
      - bash: |
          set -eux
          cd breakpad/
          make build-linux-docker-all
          # Smoke test
          make -C linux main
      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: "breakpad/linux/dist/out/breakpad-Linux.zip"
      - template: zeus-upload.yml
        parameters:
          path: ./breakpad/dist
          pattern: "*.zip"
          uploadName: "breakpad-Linux-x86_64.zip"
      - template: zeus-report.yml

  - job: breakpad_windows
    displayName: Breakpad (Windows, x86_64)
    pool:
      vmImage: "vs2017-win2016"
    steps:
      - template: prescript-common.yml
      - bash: |
          set -eux
          cd breakpad/
          make build-windows-all
      - template: zeus-report.yml

  - job: breakpad_android
    displayName: Breakpad (Android, ARM)
    pool:
      vmImage: "macos-10.13"
    steps:
      - bash: |
          env
          cd breakpad/
          find $ANDROID_NDK_HOME
          bash build-shell.sh
        env:
          BREAKPAD_CONFIGURE_FLAGS: >
            --host=arm-linux-androideabi
            --disable-processor
            --disable-tools
